// Prisma Schema for County CAD Tracker
// Production-ready schema with proper indexing and relationships

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id       String   @id @default(cuid())
  username String   @unique
  email    String   @unique
  password String // Hashed password
  role     UserRole @default(OPERATOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedTasks  Task[]         @relation("AssignedTasks")
  createdTasks   Task[]         @relation("CreatedTasks")
  notes          Note[]
  taskActivities TaskActivity[]

  @@index([email])
  @@index([username])
  @@map("users")
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

// ============================================================================
// PROPERTY MANAGEMENT
// ============================================================================

model Property {
  id            String @id @default(cuid())
  accountNumber String

  // Owner Information
  ownerName       String
  propertyAddress String  @default("") // Allow empty string for properties without address
  mailingAddress  String?

  // Financial Information
  totalDue       Float
  percentageDue  Float
  status         PropertyStatus
  previousStatus PropertyStatus?

  // Tax Information
  taxYear          Int?
  legalDescription String?

  // Scraped Data (NEW- columns from Excel)
  marketValue             Float?
  landValue               Float?
  improvementValue        Float?
  cappedValue             Float?
  agriculturalValue       Float?
  exemptions              String[] // Array of exemption types
  jurisdictions           String[] // Array of jurisdiction names
  lastPaymentDate         String? // Date as string (e.g., "12/16/2025")
  lastPaymentAmount       Float?
  lastPayer               String?
  delinquentAfter         String? // Date as string
  halfPaymentOptionAmount Float?
  priorYearsAmountDue     Float?
  yearAmountDue           Float?
  yearTaxLevy             Float?
  link                    String? // URL to property detail page
  ownerAddress            String? // Owner mailing address
  latitude                Float?
  longitude               Float?

  // Contact Information
  phoneNumbers    String[] // Array of phone numbers
  ownerPhoneIndex Int? // Index of owner's primary phone

  // Notes (simple string field for quick notes, separate from Note relation for detailed notes)
  notes String? @db.Text

  // Deal Pipeline
  dealStage          DealStage?
  estimatedDealValue Float?
  offerAmount        Float?
  expectedCloseDate  DateTime?

  // Workflow Decision Tree (same system as pre-foreclosure)
  workflowStage String @default("not_started")
  workflowLog   Json   @default("[]")

  // Metadata
  isNew             Boolean @default(false)
  isRemoved         Boolean @default(false)
  statusChanged      Boolean @default(false)
  percentageChanged Boolean @default(false)

  // Visited Status
  visited   Boolean   @default(false)
  visitedAt DateTime?
  visitedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  noteRecords    Note[]           @relation("PropertyNotes") // Detailed notes with authors
  tasks          Task[]
  paymentHistory PaymentHistory[]
  routeRecords   RouteRecord[]    // Routes this property is in

  // Indexes for performance (50k+ properties)
  @@index([accountNumber])
  @@index([status])
  @@index([dealStage])
  @@index([ownerName])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, dealStage]) // Composite index for filtering
  @@index([workflowStage])
  @@map("properties")
}

enum PropertyStatus {
  JUDGMENT
  ACTIVE
  PENDING
  PAID
  REMOVED
  UNKNOWN
}

enum DealStage {
  NEW_LEAD
  CONTACTED
  INTERESTED
  OFFER_SENT
  NEGOTIATING
  UNDER_CONTRACT
  CLOSED
  DEAD
}

// ============================================================================
// NOTES MANAGEMENT
// ============================================================================

model Note {
  id      String @id @default(cuid())
  content String @db.Text

  // Relations
  propertyId String
  property   Property @relation("PropertyNotes", fields: [propertyId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([propertyId])
  @@index([authorId])
  @@index([createdAt])
  @@map("notes")
}

// ============================================================================
// TASK MANAGEMENT WITH FULL AUDIT TRAIL
// ============================================================================

model Task {
  id String @id @default(cuid())

  // Task Details
  actionType ActionType
  priority   Priority   @default(MEDIUM)
  status     TaskStatus @default(PENDING)

  // Scheduling
  dueTime     DateTime
  completedAt DateTime?

  // Assignment
  assignedToId String?
  assignedTo   User?   @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdById String
  createdBy   User   @relation("CreatedTasks", fields: [createdById], references: [id])

  // Relations
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Task Metadata
  attempts     Int          @default(0)
  lastOutcome  TaskOutcome?
  snoozedUntil DateTime?

  // Audit Trail
  activities TaskActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for efficient querying
  @@index([propertyId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([dueTime])
  @@index([actionType])
  @@index([status, dueTime]) // Composite for "tasks due today"
  @@index([assignedToId, status]) // Composite for "my tasks"
  @@index([propertyId, status]) // Composite for property tasks
  @@map("tasks")
}

enum ActionType {
  CALL
  TEXT
  MAIL
  DRIVEBY
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  SNOOZED
}

enum TaskOutcome {
  NO_ANSWER
  VOICEMAIL
  TEXT_SENT
  SPOKE_OWNER
  WRONG_NUMBER
  NOT_INTERESTED
  NEW_OWNER
  CALL_BACK_LATER
}

// ============================================================================
// TASK ACTIVITY LOG (APPEND-ONLY AUDIT TRAIL)
// ============================================================================

model TaskActivity {
  id String @id @default(cuid())

  // What changed
  action      TaskAction
  oldValue    String?    @db.Text
  newValue    String?    @db.Text
  description String?    @db.Text

  // Relations
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Metadata (append-only, never updated)
  createdAt DateTime @default(now())

  // Indexes
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@index([taskId, createdAt]) // For chronological activity logs
  @@map("task_activities")
}

enum TaskAction {
  CREATED
  ASSIGNED
  REASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  DUE_DATE_CHANGED
  COMPLETED
  CANCELLED
  SNOOZED
  OUTCOME_RECORDED
  COMMENT_ADDED
}

// ============================================================================
// PAYMENT HISTORY
// ============================================================================

model PaymentHistory {
  id String @id @default(cuid())

  amount Float
  date   DateTime

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([propertyId])
  @@index([date])
  @@map("payment_history")
}

// ============================================================================
// FILE UPLOAD TRACKING
// ============================================================================

model FileUpload {
  id String @id @default(cuid())

  filename String
  fileId   String     @unique
  status   FileStatus @default(PROCESSING)

  // Processing stats
  totalRecords     Int?
  processedRecords Int?
  errorCount       Int     @default(0)
  errorMessage     String? @db.Text

  // Metadata
  uploadedAt  DateTime  @default(now())
  completedAt DateTime?

  @@index([status])
  @@index([uploadedAt])
  @@map("file_uploads")
}

enum FileStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// FORECLOSED PROPERTIES (PRE-FORECLOSURE)
// ============================================================================

model PreForeclosure {
  id               String      @id @default(cuid())
  documentNumber   String      @unique
  type             String // "Mortgage" or "Tax"
  address          String
  city             String
  zip              String
  filingMonth      String
  county           String      @default("Bexar")
  latitude         Float?
  longitude        Float?
  schoolDistrict   String?
  recordedDate     DateTime?
  saleDate         DateTime?
  internalStatus   String      @default("New") // "New", "Contact Attempted", "Monitoring", "Dead"
  notes            String?     @db.Text
  phoneNumbers     String[] // Array of phone numbers (up to 6)
  ownerPhoneIndex  Int? // Index of which phone number is the owner's (0-5)
  lastActionDate   DateTime?
  nextFollowUpDate DateTime?
  actionType       ActionType?
  priority         Priority?
  dueTime          DateTime?
  assignedTo       String? // "Luciano" or "Raul"
  inactive         Boolean     @default(false)
  isReturning      Boolean     @default(false) // Flagged if address matched a prior record
  previousDocumentNumbers String[] @default([]) // Chain of prior document numbers
  visited          Boolean     @default(false) // Mark if property has been visited
  visitedAt        DateTime? // When the property was visited
  visitedBy        String? // Who visited (driver name)
  visitCount       Int         @default(0) // Number of times visited
  firstSeenMonth   String
  lastSeenMonth    String
  workflowStage    String      @default("not_started")
  workflowLog      Json        @default("[]")

  // Owner Lookup (auto-populated from tax assessor + people search)
  ownerName         String?
  ownerAddress      String?
  emails            String[]    @default([])
  ownerLookupAt     DateTime?
  ownerLookupStatus String?     // "success", "partial", "failed", "pending"

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  routeRecords RouteRecord[]

  @@index([documentNumber])
  @@index([type])
  @@index([inactive])
  @@index([internalStatus])
  @@index([visited])
  @@index([visitedAt])
  @@index([workflowStage])
  @@index([isReturning])
  @@map("foreclosed")
}

// ============================================================================
// FORECLOSURE RECORDS (AUCTION NOTICES)
// ============================================================================

model Foreclosure {
  id              String    @id @default(cuid())

  // Document identifiers
  docNumber       String
  fileId          String?

  // Dates
  recordedDate    DateTime?
  saleDate        DateTime?

  // Property information
  type            String?   // Mortgage or Tax
  streetAddress   String?
  city            String?
  state           String?
  zipCode         String?

  // Additional information
  remarks         String?   @db.Text
  filingMonth     String?   // YYYY-MM format

  // Upload metadata
  uploadMode      String?   // standard or address-only
  active          Boolean   @default(true)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([docNumber])
  @@index([saleDate])
  @@index([active])
  @@index([fileId])
  @@map("foreclosures")
}

// ============================================================================
// UPLOAD HISTORY & COMPARISON TRACKING
// ============================================================================

model PreForeclosureUploadHistory {
  id String @id @default(cuid())

  // Upload Metadata
  filename String
  uploadedBy String? // Username or "System"
  uploadedAt DateTime @default(now())

  // Comparison Stats
  recordsProcessed Int // Total records in the uploaded file
  newRecords Int // Records created (didn't exist before)
  updatedRecords Int // Records that already existed and were updated
  inactiveRecords Int // Records marked as inactive (missing from new upload)

  // Summary Counts (after upload)
  totalRecords Int // Total records in database after upload
  activeRecords Int // Active records after upload

  // Upload Result
  success Boolean @default(true)
  errorMessage String? @db.Text

  // Detailed Changes (JSON array of document numbers)
  newDocumentNumbers Json? // Array of new document numbers added
  updatedDocumentNumbers Json? // Array of document numbers updated
  inactiveDocumentNumbers Json? // Array of document numbers marked inactive

  @@index([uploadedAt])
  @@index([success])
  @@map("preforeclosure_upload_history")
}

// ============================================================================
// ROUTE TRACKING
// ============================================================================

model Route {
  id String @id @default(cuid())

  // Route Details
  driver String // "Luciano" or "Raul"
  status RouteStatus @default(ACTIVE)
  routeType RouteType @default(PREFORECLOSURE) // Type of records in this route

  // Route Data (stored as JSON)
  routeData Json // Full route optimization result

  // Metadata
  createdAt  DateTime  @default(now())
  finishedAt DateTime?
  updatedAt  DateTime  @updatedAt

  // Relations
  records RouteRecord[]

  @@index([status])
  @@index([driver])
  @@index([createdAt])
  @@index([status, driver])
  @@index([routeType])
  @@map("routes")
}

enum RouteStatus {
  ACTIVE
  FINISHED
  CANCELLED
}

enum RouteType {
  PROPERTY
  PREFORECLOSURE
}

model RouteRecord {
  id String @id @default(cuid())

  // Relations
  routeId String
  route   Route  @relation(fields: [routeId], references: [id], onDelete: Cascade)

  // Optional relations - one of these will be set based on route type
  preForeclosureId String?
  preForeclosure   PreForeclosure? @relation(fields: [preForeclosureId], references: [id], onDelete: Cascade)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Position in route (for ordering)
  orderIndex Int @default(0)

  // Whether this is the starting point/depot
  isDepot Boolean @default(false)

  // Visited status (for properties - stored separately from pre-foreclosure)
  visited Boolean @default(false)
  visitedAt DateTime?
  visitedBy String?

  createdAt DateTime @default(now())

  @@index([routeId])
  @@index([preForeclosureId])
  @@index([propertyId])
  @@index([routeId, orderIndex])
  @@map("route_records")
}

// ============================================================================
// ZONE MANAGEMENT (FOR PROPERTY FILTERING & ROUTE OPTIMIZATION)
// ============================================================================

model Zone {
  id String @id @default(cuid())

  // Zone Details
  name        String
  description String? @db.Text
  type        ZoneType
  color       String // Hex color code

  // Bounds (always stored for all zone types)
  boundsNorth Float
  boundsSouth Float
  boundsEast  Float
  boundsWest  Float

  // Circle-specific data
  centerLat Float?
  centerLng Float?
  radius    Float? // in meters

  // Polygon-specific data (stored as JSON array of {lat, lng} points)
  polygon Json?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for efficient querying
  @@index([type])
  @@index([createdAt])
  @@map("zones")
}

enum ZoneType {
  RECTANGLE
  CIRCLE
  POLYGON
}

// ============================================================================
// DRIVING FOR DOLLARS (D4D) - LOGGED PROPERTIES
// ============================================================================

model DrivingLead {
  id String @id @default(cuid())

  // Address
  rawAddress String // Exactly what the user typed
  street     String
  city       String @default("San Antonio")
  state      String @default("TX")
  zip        String @default("")

  // Geocoded coordinates (filled async after creation)
  latitude  Float?
  longitude Float?

  // User notes and status
  notes  String?            @db.Text
  status DrivingLeadStatus  @default(NEW)

  // Who logged it
  loggedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("driving_leads")
}

enum DrivingLeadStatus {
  NEW
  RESEARCHING
  CONTACTED
  UNDER_CONTRACT
  DEAD
}
