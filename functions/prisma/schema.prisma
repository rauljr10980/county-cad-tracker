// Prisma Schema for County CAD Tracker
// Production-ready schema with proper indexing and relationships

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String   // Hashed password
  role      UserRole @default(OPERATOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedTasks    Task[]           @relation("AssignedTasks")
  createdTasks     Task[]           @relation("CreatedTasks")
  notes            Note[]
  taskActivities   TaskActivity[]

  @@index([email])
  @@index([username])
  @@map("users")
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

// ============================================================================
// PROPERTY MANAGEMENT
// ============================================================================

model Property {
  id                String   @id @default(cuid())
  accountNumber     String

  // Owner Information
  ownerName         String
  propertyAddress   String  @default("")  // Allow empty string for properties without address
  mailingAddress    String?

  // Financial Information
  totalDue          Float
  percentageDue     Float
  status            PropertyStatus
  previousStatus    PropertyStatus?

  // Tax Information
  taxYear           Int?
  legalDescription  String?

  // Scraped Data (NEW- columns from Excel)
  marketValue              Float?
  landValue                Float?
  improvementValue         Float?
  cappedValue              Float?
  agriculturalValue        Float?
  exemptions               String[]  // Array of exemption types
  jurisdictions            String[]  // Array of jurisdiction names
  lastPaymentDate          String?   // Date as string (e.g., "12/16/2025")
  lastPaymentAmount        Float?
  lastPayer                String?
  delinquentAfter          String?   // Date as string
  halfPaymentOptionAmount  Float?
  priorYearsAmountDue      Float?
  yearAmountDue            Float?
  yearTaxLevy              Float?
  link                     String?   // URL to property detail page
  ownerAddress             String?   // Owner mailing address

  // Contact Information
  phoneNumbers      String[]  // Array of phone numbers
  ownerPhoneIndex   Int?      // Index of owner's primary phone

  // Deal Pipeline
  dealStage         DealStage?
  estimatedDealValue Float?
  offerAmount       Float?
  expectedCloseDate DateTime?

  // Metadata
  isNew             Boolean   @default(false)
  isRemoved         Boolean   @default(false)
  statusChanged     Boolean   @default(false)
  percentageChanged Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  notes             Note[]
  tasks             Task[]
  paymentHistory    PaymentHistory[]

  // Indexes for performance (50k+ properties)
  @@index([accountNumber])
  @@index([status])
  @@index([dealStage])
  @@index([ownerName])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([status, dealStage]) // Composite index for filtering
  @@map("properties")
}

enum PropertyStatus {
  JUDGMENT
  ACTIVE
  PENDING
  PAID
  REMOVED
  UNKNOWN
}

enum DealStage {
  NEW_LEAD
  CONTACTED
  INTERESTED
  OFFER_SENT
  NEGOTIATING
  UNDER_CONTRACT
  CLOSED
  DEAD
}

// ============================================================================
// NOTES MANAGEMENT
// ============================================================================

model Note {
  id         String   @id @default(cuid())
  content    String   @db.Text

  // Relations
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  authorId   String
  author     User     @relation(fields: [authorId], references: [id])

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Indexes
  @@index([propertyId])
  @@index([authorId])
  @@index([createdAt])
  @@map("notes")
}

// ============================================================================
// TASK MANAGEMENT WITH FULL AUDIT TRAIL
// ============================================================================

model Task {
  id          String       @id @default(cuid())

  // Task Details
  actionType  ActionType
  priority    Priority     @default(MEDIUM)
  status      TaskStatus   @default(PENDING)

  // Scheduling
  dueTime     DateTime
  completedAt DateTime?

  // Assignment
  assignedToId String?
  assignedTo   User?        @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdById  String
  createdBy    User         @relation("CreatedTasks", fields: [createdById], references: [id])

  // Relations
  propertyId   String
  property     Property     @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Task Metadata
  attempts     Int          @default(0)
  lastOutcome  TaskOutcome?
  snoozedUntil DateTime?

  // Audit Trail
  activities   TaskActivity[]

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Indexes for efficient querying
  @@index([propertyId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([dueTime])
  @@index([actionType])
  @@index([status, dueTime]) // Composite for "tasks due today"
  @@index([assignedToId, status]) // Composite for "my tasks"
  @@index([propertyId, status]) // Composite for property tasks
  @@map("tasks")
}

enum ActionType {
  CALL
  TEXT
  MAIL
  DRIVEBY
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  SNOOZED
}

enum TaskOutcome {
  NO_ANSWER
  VOICEMAIL
  TEXT_SENT
  SPOKE_OWNER
  WRONG_NUMBER
  NOT_INTERESTED
  NEW_OWNER
  CALL_BACK_LATER
}

// ============================================================================
// TASK ACTIVITY LOG (APPEND-ONLY AUDIT TRAIL)
// ============================================================================

model TaskActivity {
  id          String   @id @default(cuid())

  // What changed
  action      TaskAction
  oldValue    String?   @db.Text
  newValue    String?   @db.Text
  description String?   @db.Text

  // Relations
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  // Metadata (append-only, never updated)
  createdAt   DateTime @default(now())

  // Indexes
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@index([taskId, createdAt]) // For chronological activity logs
  @@map("task_activities")
}

enum TaskAction {
  CREATED
  ASSIGNED
  REASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  DUE_DATE_CHANGED
  COMPLETED
  CANCELLED
  SNOOZED
  OUTCOME_RECORDED
  COMMENT_ADDED
}

// ============================================================================
// PAYMENT HISTORY
// ============================================================================

model PaymentHistory {
  id         String   @id @default(cuid())

  amount     Float
  date       DateTime

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@index([propertyId])
  @@index([date])
  @@map("payment_history")
}

// ============================================================================
// FILE UPLOAD TRACKING
// ============================================================================

model FileUpload {
  id              String   @id @default(cuid())

  filename        String
  fileId          String   @unique
  status          FileStatus @default(PROCESSING)

  // Processing stats
  totalRecords    Int?
  processedRecords Int?
  errorCount      Int       @default(0)
  errorMessage    String?   @db.Text

  // Metadata
  uploadedAt      DateTime  @default(now())
  completedAt     DateTime?

  @@index([status])
  @@index([uploadedAt])
  @@map("file_uploads")
}

enum FileStatus {
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// PRE-FORECLOSURE RECORDS
// ============================================================================

model PreForeclosure {
  id                String   @id @default(cuid())
  documentNumber    String   @unique
  type              String   // "Mortgage" or "Tax"
  address           String
  city              String
  zip               String
  filingMonth       String
  county            String   @default("Bexar")
  internalStatus    String   @default("New") // "New", "Contact Attempted", "Monitoring", "Dead"
  notes             String?  @db.Text
  lastActionDate    String?
  nextFollowUpDate  String?
  inactive          Boolean  @default(false)
  firstSeenMonth    String
  lastSeenMonth     String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([documentNumber])
  @@index([type])
  @@index([inactive])
  @@index([internalStatus])
  @@map("pre_foreclosures")
}